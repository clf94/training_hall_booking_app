<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Training Hall Booking</title>
<link rel="icon" href="/static/logo.png" type="image/png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% include 'styles.html' %}
<style>
.disabled-slot { color: #aaa; }
#bookingWarning { color: red; font-weight: bold; margin-bottom: 0.5rem; }
</style>
</head>
<body class="bg-light">

<div class="container my-4 text-center">
  <img src="/static/logo.png" class="logo" alt="logo">
  <h1>Tischtennisclub Z√ºrich Affoltern</h1>
  {% if not is_admin %}
    <a href="{{ url_for('admin.admin_login') }}" class="btn btn-warning mt-2">Admin Login</a>
  {% else %}
    <a href="{{ url_for('admin.admin_logout') }}" class="btn btn-danger mt-2">Admin Logout</a>
  {% endif %}
</div>

{% if is_admin %}
  {% include 'admin_section.html' %}
{% endif %}
	  {% include 'booking_rules.html' %}

<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-4 col-sm-12 mb-3">
      {% include 'live_occupancy.html' %}
    </div>
    <div class="col-md-8 col-sm-12">
      {% include 'book_session.html' %}
    </div>
  </div>
</div>
<hr>

<h3 class="text-center">Bookings</h3>
<div id="bookings" class="container mb-5">
    <div id="bookings-today"></div>
    <div id="bookings-nextday"></div>
</div>

{% include 'booking_modal.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const playerSelect = document.getElementById('player');
  const partnerSelect = document.getElementById('partner');
  const playerExternal = document.getElementById('player_external');
  const partnerExternal = document.getElementById('partner_external');
  const startSelect = document.getElementById('start');
  const endSelect = document.getElementById('end');
  const daySelect = document.getElementById('day');
  const submitBtn = document.getElementById('submitBtn');
  const occupancyValue = document.getElementById('occupancyValue');
  const matchDayNotice = document.getElementById('matchDayNotice');
  const matchInfo = document.getElementById('matchInfo');

  const allowedDays = [2, 4, 5]; // Tue=2, Thu=4, Fri=5
  const weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

function nextAvailableDay(fromDate){
  let d = new Date(fromDate);
  while(!allowedDays.includes(d.getDay())){
    d.setDate(d.getDate() + 1);
  }
  return d;
}

const today = new Date();
let firstAvailable = nextAvailableDay(today);
let secondAvailable = nextAvailableDay(new Date(firstAvailable.getTime() + 24*60*60*1000));

const dayOptions = [
  { 
    label: firstAvailable.toDateString() === today.toDateString() 
           ? `${weekdays[firstAvailable.getDay()]} (Today)` 
           : `${weekdays[firstAvailable.getDay()]}`, 
    value: firstAvailable.toISOString().split('T')[0] 
  },
  { 
    label: secondAvailable.toDateString() === today.toDateString() 
           ? `${weekdays[secondAvailable.getDay()]} (Today)` 
           : `${weekdays[secondAvailable.getDay()]}`, 
    value: secondAvailable.toISOString().split('T')[0] 
  }
];
dayOptions.forEach(o => daySelect.appendChild(new Option(o.label, o.value)));
daySelect.value = dayOptions[0].value;

  const slots = [];
  const base = new Date(); base.setHours(6,0,0,0);
  const SLOT_COUNT = 72;
  for (let i=0; i<=SLOT_COUNT; i++){
    const d = new Date(base.getTime() + i*15*60000);
    slots.push(d.toTimeString().slice(0,5));
  }

  function populatePartners(){
    const selected = playerSelect.value;
    partnerSelect.innerHTML = '<option value="">-- None --</option>';
    {% for u in users %} if ("{{u}}" !== selected) partnerSelect.innerHTML += `<option value="{{u}}">{{u}}</option>`; {% endfor %}
    partnerSelect.innerHTML += '<option value="other">Other</option>';
  }
  playerSelect.addEventListener('change', ()=>{ 
    playerExternal.style.display = playerSelect.value==='other'?'block':'none'; 
    populatePartners(); 
  });
  partnerSelect.addEventListener('change', ()=>{ partnerExternal.style.display = partnerSelect.value==='other'?'block':'none'; });

  daySelect.addEventListener('change', ()=>populateStartTimes(lastOccupancy));

  {% if is_admin %}
  const matchStartSelect = document.getElementById('match_start');
  const matchEndSelect = document.getElementById('match_end');
  slots.forEach(t=>{ matchStartSelect.append(new Option(t,t)); matchEndSelect.append(new Option(t,t)); });
  matchStartSelect.value="{{ match_start }}"; matchEndSelect.value="{{ match_end }}";
  document.getElementById('match_day').addEventListener('change', ()=>{ document.getElementById('match_range').style.display=document.getElementById('match_day').checked?'block':'none'; });
  {% endif %}

  function isoToday(){ return new Date().toISOString().split('T')[0]; }
  function nowTime(){ return new Date().toTimeString().slice(0,5); }

  let lastOccupancy=null;
  let playerBookings={};

  function updatePlayerBookings(list){
    playerBookings={};
    list.forEach(b=>{
      if(!playerBookings[b.day]) playerBookings[b.day]={};
      if(!playerBookings[b.day][b.player]) playerBookings[b.day][b.player]=[];
      playerBookings[b.day][b.player].push({start:b.start,end:b.end});
      if(b.partner && !b.partner.startsWith('None-')){
        if(!playerBookings[b.day][b.partner]) playerBookings[b.day][b.partner]=[];
        playerBookings[b.day][b.partner].push({start:b.start,end:b.end});
      }
    });
  }

  function populateStartTimes(occupancy){
    lastOccupancy = occupancy;
    const prevStart = startSelect.value;
    startSelect.innerHTML = '';
    const selectedDay = daySelect.value;
    const isTodaySelected = selectedDay === isoToday();
    const now = nowTime();
    let allDisabled=true;

    const currentPlayer = (playerSelect.value==='other')?playerExternal.value.trim():playerSelect.value;
    const currentPlayerBookings = (playerBookings[selectedDay] && playerBookings[selectedDay][currentPlayer])||[];

    slots.slice(0, slots.length-1).forEach(t=>{
      const opt = new Option(t,t);
      if(isTodaySelected && t<=now) opt.disabled=true;

      if(occupancy.match_day && occupancy.match_start && occupancy.match_end){
        const inRange = t>=occupancy.match_start && t<occupancy.match_end;
        if(inRange && occupancy.occupied>=occupancy.capacity) opt.disabled=true;
      }

      const totalMinutes = currentPlayerBookings.reduce((sum,b)=>{
        const s = parseInt(b.start.split(':')[0])*60 + parseInt(b.start.split(':')[1]);
        const e = parseInt(b.end.split(':')[0])*60 + parseInt(b.end.split(':')[1]);
        return sum + (e-s);
      },0);
      if(totalMinutes>=60) opt.disabled=true;

      if(!opt.disabled) allDisabled=false;
      startSelect.append(opt);
    });

    if(allDisabled){
      startSelect.innerHTML='<option disabled selected>No available start times</option>';
      endSelect.innerHTML='<option disabled selected>No available end times</option>';
      submitBtn.disabled=true;
      return;
    } else {
      clearBookingWarning();
    }

    const stillValid = Array.from(startSelect.options).some(o => o.value===prevStart && !o.disabled);
    if(stillValid) startSelect.value=prevStart;
    else startSelect.selectedIndex = Array.from(startSelect.options).findIndex(o=>!o.disabled);

    submitBtn.disabled=false;
    updateEnd();
  }

  function updateEnd(){
    endSelect.innerHTML='';
    if(startSelect.selectedIndex===-1) return;
    const chosenStart=startSelect.value;
    const selectedDay=daySelect.value;
    const now=nowTime();
    let allDisabled=true;

    const currentPlayer = (playerSelect.value==='other')?playerExternal.value.trim():playerSelect.value;
    const currentPlayerBookings = (playerBookings[selectedDay] && playerBookings[selectedDay][currentPlayer])||[];
    const totalMinutesBooked = currentPlayerBookings.reduce((sum,b)=>{
      const s = parseInt(b.start.split(':')[0])*60 + parseInt(b.start.split(':')[1]);
      const e = parseInt(b.end.split(':')[0])*60 + parseInt(b.end.split(':')[1]);
      return sum + (e-s);
    },0);
    const maxDuration = Math.min(60-totalMinutesBooked,60);

    slots.forEach(t=>{
      if(t<=chosenStart) return;
      const opt = new Option(t,t);
      const startMinutes = parseInt(chosenStart.split(':')[0])*60 + parseInt(chosenStart.split(':')[1]);
      const endMinutes = parseInt(t.split(':')[0])*60 + parseInt(t.split(':')[1]);
      if(endMinutes-startMinutes>maxDuration) opt.disabled=true;
      if(selectedDay===isoToday() && t<=now) opt.disabled=true;

      if(lastOccupancy && lastOccupancy.match_day && lastOccupancy.match_start && lastOccupancy.match_end){
        const inRange = t>lastOccupancy.match_start && t<=lastOccupancy.match_end;
        if(inRange && lastOccupancy.occupied>=lastOccupancy.capacity) opt.disabled=true;
      }

      if(!opt.disabled) allDisabled=false;
      endSelect.append(opt);
    });

    if(allDisabled){
      endSelect.innerHTML='<option disabled selected>No available end times</option>';
      submitBtn.disabled=true;
    } else {
      endSelect.selectedIndex = Array.from(endSelect.options).findIndex(o=>!o.disabled);
      submitBtn.disabled=false;
    }
  }

  function showBookingWarning(msg){
    let warning=document.getElementById('bookingWarning');
    if(!warning){
      const form=document.getElementById('bookingForm');
      warning=document.createElement('div');
      warning.id='bookingWarning';
      warning.className='text-danger fw-bold mb-2';
      form.prepend(warning);
    }
    warning.textContent=msg;
    warning.style.display='block';
  }

  function clearBookingWarning(){
    const warning=document.getElementById('bookingWarning');
    if(warning) warning.style.display='none';
  }

  function zurichDateString(dateStr){
    const date=new Date(dateStr+"T00:00:00Z");
    return date.toLocaleDateString('de-DE',{weekday:'long',year:'numeric',month:'2-digit',day:'2-digit',timeZone:'Europe/Zurich'});
  }

  async function loadBookings(){
    const res = await fetch('/bookings?t='+Date.now());
    const list = await res.json();
    updatePlayerBookings(list);

    const todayStr = dayOptions[0].value;
    const nextDayStr = dayOptions[1].value;

    const todayContainer = document.getElementById('bookings-today');
    const nextDayContainer = document.getElementById('bookings-nextday');

    todayContainer.innerHTML = `<h5>Bookings ‚Äî ${zurichDateString(todayStr)}</h5>`;
    nextDayContainer.innerHTML = `<h5>Bookings ‚Äî ${zurichDateString(nextDayStr)}</h5>`;

function groupByPeriod(bookings) {
  const grouped = { Morning: [], Afternoon: [], Evening: [] };
  bookings.forEach(b => {
    const hour = parseInt(b.start.split(':')[0]);
    if (hour < 12) grouped.Morning.push(b);
    else if (hour < 18) grouped.Afternoon.push(b);
    else grouped.Evening.push(b);
  });
  return grouped;
}

function renderPeriod(bookings, label, container, index) {
  const collapseId = 'collapse-' + label.toLowerCase();
  const isFirst = index === 0; // Only first (Morning) starts open

  const section = document.createElement('div');
  section.className = 'mb-3';
  const icons = { Morning: "üåÖ", Afternoon: "üåû", Evening: "üåô" };
  section.innerHTML = `
    <button class="btn btn-outline-primary w-100 text-start mb-2" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#${collapseId}" 
            aria-expanded="${isFirst}" 
            aria-controls="${collapseId}">
       ${icons[label]} ${label}
    </button>
    <div class="collapse ${isFirst ? 'show' : ''}" id="${collapseId}">
      <div class="card card-body p-2"></div>
    </div>
  `;

  const cardBody = section.querySelector('.card-body');

  if (bookings.length === 0) {
    cardBody.innerHTML = `<p class="text-center text-muted">No bookings yet</p>`;
    container.appendChild(section);
    return;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0); // normalize to midnight

  bookings.forEach(b => {
    const card = document.createElement('div');
    card.className = 'card p-2 mb-2 shadow-sm';

    const bookedTime = b.created_at
      ? new Date(b.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : 'Unknown';
    const checkinTime = b.checked_in_at
      ? ` | Checked in: ${new Date(b.checked_in_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`
      : '';
    const partnerText = b.partner ? b.partner : "(no partner)";
    const timeText = `(${b.start}‚Äì${b.end} ‚Äî Booked at: ${bookedTime}${checkinTime})`;

    // Convert booking day to Date
    const bookingDate = new Date(b.day + 'T00:00:00');
    bookingDate.setHours(0, 0, 0, 0);

    const isFuture = bookingDate > today;
    const isPast = bookingDate < today;

    let buttons = '';

    if (b.status === 'booked') {
      if (isFuture) {
        buttons += `<button class="btn btn-success btn-sm me-2" disabled title="Cannot check in for future days">Check-in</button>`;
      } else if (isPast) {
        buttons += `<button class="btn btn-success btn-sm me-2" disabled title="Booking in the past">Check-in</button>`;
      } else {
        buttons += `<button class="btn btn-success btn-sm me-2" onclick="checkin(${b.booking_id})">Check-in</button>`;
      }
    }

    if (b.status === 'checked-in') {
      buttons += `<button class="btn btn-warning btn-sm me-2" onclick="checkout(${b.booking_id})">Checkout</button>`;
    }

    {% if is_admin %}
      buttons += `<button class="btn btn-danger btn-sm" onclick="deleteBooking(${b.booking_id})">Delete</button>`;
    {% endif %}

    card.innerHTML = `
      <div><b>${b.player}</b> <i>${timeText}</i> + ${partnerText}</div>
      <div>Booked for: ${b.day}</div>
      <div>Status: <b>${b.status}</b></div>
      <div class="mt-1">${buttons}</div>
    `;
    cardBody.appendChild(card);
  });

  container.appendChild(section);
}



    const todayBookings=list.filter(b=>b.day===todayStr).sort((a,b)=>a.start.localeCompare(b.start));
    const nextBookings=list.filter(b=>b.day===nextDayStr).sort((a,b)=>a.start.localeCompare(b.start));

   const groupedToday = groupByPeriod(todayBookings);
['Morning', 'Afternoon', 'Evening'].forEach((p, i) => renderPeriod(groupedToday[p], p, todayContainer, i));

const groupedNext = groupByPeriod(nextBookings);
['Morning', 'Afternoon', 'Evening'].forEach((p, i) => renderPeriod(groupedNext[p], p, nextDayContainer, i));

    if(todayBookings.length===0 && nextBookings.length===0){
      todayContainer.innerHTML="<p class='text-center text-muted'>No bookings yet</p>";
      nextDayContainer.innerHTML="<p class='text-center text-muted'>No bookings yet</p>";
    }
  }
async function loadOccupancy() {
    const res = await fetch('/occupancy?t=' + Date.now());
    const j = await res.json();

    // Update occupancy display
    occupancyValue.textContent = `${j.occupied} / ${j.capacity}`;
    occupancyValue.className =
        "fs-3 fw-bold " +
        (j.occupied < 6 ? "occupancy-green" :
         j.occupied < 11 ? "occupancy-yellow" : "occupancy-red");

    const tablesReserved = Math.ceil(j.occupied / 2);
    const matchWarning = document.getElementById('matchWarning');

    // Make sure the warning div exists
    if (!matchWarning) {
        console.warn("‚ö†Ô∏è matchWarning element not found in DOM.");
        return;
    }

    // If there is a match today
    if (j.match_day && j.match_start && j.match_end) {
        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes();
        const matchStartMinutes = parseInt(j.match_start.split(':')[0]) * 60 + parseInt(j.match_start.split(':')[1]);
        const matchEndMinutes = parseInt(j.match_end.split(':')[0]) * 60 + parseInt(j.match_end.split(':')[1]);

        let whenText = '';
        let warningText = '';

        if (nowMinutes >= matchStartMinutes && nowMinutes <= matchEndMinutes) {
            // üü• Match ongoing
            whenText = 'ongoing';
            if (j.occupied >= j.capacity) {
                warningText = `‚ö†Ô∏è Match ongoing (${j.match_start} ‚Äì ${j.match_end}). All tables are currently full. Bookings are disabled.`;
            } else {
                warningText = `‚ö†Ô∏è Match ongoing (${j.match_start} ‚Äì ${j.match_end}). Tables reserved: ${tablesReserved}. Please book carefully.`;
            }
            matchWarning.className = "alert alert-danger fw-bold text-center";
        } else if (nowMinutes < matchStartMinutes) {
            // üü® Match upcoming
            whenText = 'upcoming';
            warningText = `‚ö†Ô∏è Upcoming match today (${j.match_start} ‚Äì ${j.match_end}). Tables reserved: ${tablesReserved}. Please plan your bookings carefully.`;
            matchWarning.className = "alert alert-warning fw-bold text-center";
        } else {
            // üü© Match finished
            whenText = 'finished';
            warningText = `‚úÖ Match finished (${j.match_start} ‚Äì ${j.match_end}). You can book freely now.`;
            matchWarning.className = "alert alert-success fw-bold text-center";
        }

        // Always display the banner
        matchWarning.style.display = 'block';
        matchWarning.textContent = warningText;

    } else {
        // No match scheduled
        matchWarning.style.display = 'none';
    }

    populateStartTimes(j);
}



  document.getElementById('bookingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const player=(playerSelect.value==='other')?playerExternal.value.trim():playerSelect.value;
    if(!player){alert('Please enter player name'); return;}
    let partner=(partnerSelect.value==='other')?partnerExternal.value.trim()||null:partnerSelect.value||null;
    let partnerToSend=partner||`None-${Date.now()}-${Math.floor(Math.random()*10000)}`;
    const fd=new FormData();
    fd.append('player',player); fd.append('partner',partnerToSend);
    fd.append('day',daySelect.value); fd.append('start',startSelect.value); fd.append('end',endSelect.value);
    const resp=await fetch('/book',{method:'POST',body:fd}); const j=await resp.json();
    if(j.ok){
      document.getElementById('bookingForm').reset();
      playerExternal.style.display='none'; partnerExternal.style.display='none';
      await loadBookings(); await loadOccupancy();
      new bootstrap.Modal(document.getElementById('userPopup')).show();
    } else alert(j.error||'Booking failed');
  });

  window.checkin=async id=>{ await fetch('/checkin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({booking_id:id})}); await loadBookings(); await loadOccupancy(); };
  window.checkout=async id=>{ await fetch('/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({booking_id:id})}); await loadBookings(); await loadOccupancy(); };
  window.deleteBooking=async id=>{ await fetch('/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({booking_id:id})}); await loadBookings(); await loadOccupancy(); };

  {% if is_admin %}
  document.getElementById('save_settings').addEventListener('click', async ()=>{
    const payload={
      match_day:document.getElementById('match_day').checked,
      match_start:document.getElementById('match_start').value||"",
      match_end:document.getElementById('match_end').value||"",
      extra_table:document.getElementById('extra_table').checked,
      second_match:document.getElementById('second_match').checked,
      second_match_extra_table:document.getElementById('second_match_extra_table').checked
    };
    await fetch('/update-settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    await loadOccupancy(); await loadBookings();
  });
  {% endif %}

  loadBookings(); loadOccupancy();
  setInterval(loadOccupancy,5000);
});
</script>

{% include 'footer.html' %}
</body>
</html>
