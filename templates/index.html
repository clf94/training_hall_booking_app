<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Training Hall Booking</title>
<link rel="icon" href="/static/logo.png" type="image/png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.occupancy-green { color: green; }
.occupancy-yellow { color: goldenrod; }
.occupancy-red { color: red; }
.logo { max-height:60px;margin-bottom:20px; }
.admin-section { margin-bottom:20px; }
</style>
</head>
<body class="bg-light">

<div class="container my-4 text-center">
  <img src="/static/logo.png" class="logo">
  <h1>Tischtennisclub Zürich Affoltern</h1>
  {% if not is_admin %}
  <a href="{{ url_for('admin_login') }}" class="btn btn-warning mt-2">Admin Login</a>
  {% else %}
  <a href="{{ url_for('admin_logout') }}" class="btn btn-danger mt-2">Admin Logout</a>
  {% endif %}
</div>

{% if is_admin %}
<div class="container admin-section">
  <div class="card p-3 shadow-sm">
    <h5>Admin Section</h5>
    <div class="form-check mb-2">
      <input type="checkbox" class="form-check-input" id="match_day" {% if match_day %}checked{% endif %}>
      <label class="form-check-label" for="match_day">Match Day (2 tables)</label>
    </div>
    <div class="form-check mb-2">
      <input type="checkbox" class="form-check-input" id="extra_table" {% if extra_table %}checked{% endif %}>
      <label class="form-check-label" for="extra_table">Extra Table</label>
    </div>
  </div>
</div>
{% endif %}

<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-4 col-sm-12 mb-3">
      <div class="card text-center p-3 shadow-sm">
        <h5>Live Occupancy</h5>
        <div id="occupancyValue" class="fs-3 fw-bold occupancy-green">0 / 12</div>
        <div id="matchDayNotice" class="text-center text-primary fw-bold" style="display:none;">Match Day!</div>
      </div>
    </div>

    <div class="col-md-8 col-sm-12">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Book a Session</h5>
        <form id="bookingForm">
          <div class="mb-2">
            <label>Player</label>
            <select id="player" name="player" class="form-select" required>
              <option value="">-- Select player --</option>
              {% for u in users %}<option value="{{ u }}">{{ u }}</option>{% endfor %}
              <option value="other">Other</option>
            </select>
            <input type="text" id="player_external" placeholder="Enter player name" class="form-control mt-1" style="display:none;">
          </div>

          <div class="mb-2">
            <label>Partner</label>
            <select id="partner" name="partner" class="form-select">
              <option value="">-- None --</option>
              {% for u in users %}<option value="{{ u }}">{{ u }}</option>{% endfor %}
              <option value="other">Other</option>
            </select>
            <input type="text" id="partner_external" placeholder="Enter partner name" class="form-control mt-1" style="display:none;">
          </div>

          <div class="mb-2">
            <label>Day</label>
            <input type="date" id="day" name="day" class="form-control" value="{{ date.isoformat() }}" readonly required>
          </div>

          <div class="mb-2">
            <label>Start Time</label>
            <select id="start" name="start" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label>End Time</label>
            <select id="end" name="end" class="form-select" required></select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Book</button>
        </form>
      </div>
    </div>
  </div>
</div>

<hr>
<h3 class="text-center">Bookings</h3>
<div id="bookings" class="container mb-5"></div>

<!-- User popup modal -->
<div class="modal fade" id="userPopup" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Booking successful!</h5>
      </div>
      <div class="modal-body">
        If you want to cancel your booking, please contact an admin.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const playerSelect=document.getElementById("player");
  const partnerSelect=document.getElementById("partner");
  const playerExternal=document.getElementById("player_external");
  const partnerExternal=document.getElementById("partner_external");
  const startSelect=document.getElementById("start");
  const endSelect=document.getElementById("end");
  const matchDayNotice=document.getElementById("matchDayNotice");
  const dayInput=document.getElementById("day");
  const isAdmin={{ 'true' if is_admin else 'false' }};

  function populatePartners(){
    const selected=playerSelect.value;
    partnerSelect.innerHTML='<option value="">-- None --</option>';
    {% for u in users %}
      if("{{ u }}"!==selected) partnerSelect.innerHTML+=`<option value="{{ u }}">{{ u }}</option>`;
    {% endfor %}
    partnerSelect.innerHTML+='<option value="other">Other</option>';
  }

  playerSelect.addEventListener("change", ()=>{
    playerExternal.style.display=playerSelect.value=="other"?"block":"none";
    populatePartners();
  });
  partnerSelect.addEventListener("change", ()=>{
    partnerExternal.style.display=partnerSelect.value=="other"?"block":"none";
  });

  // 15-min slots
  const slots = [];
  let base = new Date();
  base.setHours(8, 0, 0, 0);
  for (let i = 0; i <= 60; i++) {
      const t = new Date(base.getTime() + i * 15 * 60000);
      const time = t.toTimeString().slice(0, 5);
      slots.push(time);
  }

  function populateStartTimes(){
    startSelect.innerHTML = '';
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0,5);
    slots.forEach(t=>{
      if(!isAdmin && dayInput.value===today && t<=currentTime) return; // disable past
      startSelect.append(new Option(t,t));
    });
  }

  function updateEnd() {
      endSelect.innerHTML = "";
      for (let i = startSelect.selectedIndex + 1; i < slots.length; i++) {
          endSelect.append(new Option(slots[i], slots[i]));
      }
  }

  startSelect.addEventListener("change", updateEnd);
  populateStartTimes();
  updateEnd();

  // Occupancy & bookings
  async function loadOccupancy(){
    const res=await fetch("/occupancy");
    const j=await res.json();
    const el=document.getElementById("occupancyValue");
    el.textContent=`${j.occupied} / ${j.capacity}`;
    el.className="fs-3 fw-bold "+(j.occupied<6?"occupancy-green":j.occupied<11?"occupancy-yellow":"occupancy-red");
    matchDayNotice.style.display=j.match_day?"block":"none";
  }

  async function loadBookings(){
  const res=await fetch("/bookings");
  const bookings=await res.json();
  const div=document.getElementById("bookings");
  div.innerHTML="";
  if(bookings.length===0){div.innerHTML="<p class='text-center text-muted'>No bookings yet</p>";return;}
  bookings.forEach(b=>{
    const card=document.createElement("div");
    card.className="card p-2 mb-2 shadow-sm";
    let buttons="";
    if(b.status==="booked") buttons+=`<button class="btn btn-success btn-sm me-2" onclick="checkin(${b.booking_id})">Check-in</button>`;
    if(b.status==="checked-in") buttons+=`<button class="btn btn-warning btn-sm me-2" onclick="checkout(${b.booking_id})">Checkout</button>`;
    {% if is_admin %}
    buttons+=`<button class="btn btn-danger btn-sm" onclick="deleteBooking(${b.booking_id})">Delete</button>`;
    {% endif %}
    card.innerHTML=`
      <div><b>${b.player}</b>${b.partner?" + "+b.partner:""}</div>
      <div>${b.day} | ${b.start}–${b.end}</div>
      <div>Status: <b>${b.status}</b></div>
      <div class="mt-2">${buttons}</div>`;
    div.appendChild(card);
  });
}


  function showUserPopup(){
    const modal = new bootstrap.Modal(document.getElementById('userPopup'));
    modal.show();
  }

  document.getElementById("bookingForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const data=new FormData(e.target);
    const resp=await fetch("/book",{method:"POST",body:data});
    const j=await resp.json();
    if(j.ok){
      e.target.reset();
      playerExternal.style.display="none";
      partnerExternal.style.display="none";
      populateStartTimes();
      updateEnd();
      await loadBookings();
      showUserPopup();
    } else alert(j.error);
  });

  window.checkin=async id=>{await fetch("/checkin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({booking_id:id})});await loadBookings();await loadOccupancy();}
  window.checkout=async id=>{await fetch("/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({booking_id:id})});await loadBookings();await loadOccupancy();}
  window.deleteBooking=async id=>{await fetch("/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({booking_id:id})});await loadBookings();await loadOccupancy();}

  {% if is_admin %}
  const matchCheck=document.getElementById("match_day");
  const extraCheck=document.getElementById("extra_table");
  matchCheck.addEventListener("change", async ()=>{
    await fetch("/update-settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({match_day:matchCheck.checked,extra_table:extraCheck.checked})});
    await loadOccupancy();
  });
  extraCheck.addEventListener("change", async ()=>{
    await fetch("/update-settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({match_day:matchCheck.checked,extra_table:extraCheck.checked})});
    await loadOccupancy();
  });
  {% endif %}

  loadBookings();
  loadOccupancy();
  setInterval(loadOccupancy,5000);
});
</script>

<footer class="text-center mt-5 mb-3 text-muted" style="font-size: 0.9rem;">
  © Copyright 2025 <br>
  Luca F.Caldesi (<a href="mailto:lfcaldesi@gmail.com">lfcaldesi@gmail.com</a>)
</footer>

</body>
</html>
