<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Training Hall Booking</title>
<link rel="icon" href="/static/logo.png" type="image/png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% include 'styles.html' %}
</head>
<body class="bg-light">

<div class="container my-4 text-center">
  <img src="/static/logo.png" class="logo" alt="logo">
  <h1>Tischtennisclub Zürich Affoltern</h1>
  {% if not is_admin %}
    <a href="{{ url_for('admin.admin_login') }}" class="btn btn-warning mt-2">Admin Login</a>
  {% else %}
    <a href="{{ url_for('admin.admin_logout') }}" class="btn btn-danger mt-2">Admin Logout</a>
  {% endif %}
</div>

{% if is_admin %}
  {% include 'admin_section.html' %}
{% endif %}

<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-4 col-sm-12 mb-3">
      {% include 'live_occupancy.html' %}
    </div>
    <div class="col-md-8 col-sm-12">
      {% include 'book_session.html' %}
    </div>
  </div>
</div>
<hr>

<h3 class="text-center">Bookings</h3>
<div id="bookings" class="container mb-5">
    <div id="bookings-today"></div>
    <div id="bookings-tomorrow"></div>
</div>

{% include 'booking_modal.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const playerSelect = document.getElementById('player');
  const partnerSelect = document.getElementById('partner');
  const playerExternal = document.getElementById('player_external');
  const partnerExternal = document.getElementById('partner_external');
  const startSelect = document.getElementById('start');
  const endSelect = document.getElementById('end');
  const daySelect = document.getElementById('day');
  const submitBtn = document.getElementById('submitBtn');
  const occupancyValue = document.getElementById('occupancyValue');
  const matchDayNotice = document.getElementById('matchDayNotice');
  const matchInfo = document.getElementById('matchInfo');

  const today = new Date();
  const tomorrow = new Date();
  tomorrow.setDate(today.getDate() + 1);
  const dayOptions = [
    { label: 'Today', value: today.toISOString().split('T')[0] },
    { label: 'Tomorrow', value: tomorrow.toISOString().split('T')[0] }
  ];
  dayOptions.forEach(o => daySelect.appendChild(new Option(o.label, o.value)));
  daySelect.value = dayOptions[0].value;

  const slots = [];
  const base = new Date(); base.setHours(6,0,0,0);
  const SLOT_COUNT = 72;
  for (let i=0; i<=SLOT_COUNT; i++){
    const d = new Date(base.getTime() + i*15*60000);
    slots.push(d.toTimeString().slice(0,5));
  }

  function populatePartners(){
    const selected = playerSelect.value;
    partnerSelect.innerHTML = '<option value="">-- None --</option>';
    {% for u in users %} if ("{{u}}" !== selected) partnerSelect.innerHTML += `<option value="{{u}}">{{u}}</option>`; {% endfor %}
    partnerSelect.innerHTML += '<option value="other">Other</option>';
  }
  playerSelect.addEventListener('change', ()=>{ 
    playerExternal.style.display = playerSelect.value==='other'?'block':'none'; 
    populatePartners(); 
  });
  partnerSelect.addEventListener('change', ()=>{ partnerExternal.style.display = partnerSelect.value==='other'?'block':'none'; });

  {% if is_admin %}
  const matchStartSelect = document.getElementById('match_start');
  const matchEndSelect = document.getElementById('match_end');
  slots.forEach(t=>{ matchStartSelect.append(new Option(t,t)); matchEndSelect.append(new Option(t,t)); });
  matchStartSelect.value="{{ match_start }}"; matchEndSelect.value="{{ match_end }}";
  document.getElementById('match_day').addEventListener('change', ()=>{ document.getElementById('match_range').style.display=document.getElementById('match_day').checked?'block':'none'; });
  {% endif %}

  function isoToday(){ return new Date().toISOString().split('T')[0]; }
  function nowTime(){ return new Date().toTimeString().slice(0,5); }

  let lastOccupancy=null;
  let playerBookings={};

  function updatePlayerBookings(list){
    playerBookings={};
    list.forEach(b=>{
      if(!playerBookings[b.day]) playerBookings[b.day]={};
      if(!playerBookings[b.day][b.player]) playerBookings[b.day][b.player]=[];
      playerBookings[b.day][b.player].push({start:b.start,end:b.end});
      if(b.partner && !b.partner.startsWith('None-')){
        if(!playerBookings[b.day][b.partner]) playerBookings[b.day][b.partner]=[];
        playerBookings[b.day][b.partner].push({start:b.start,end:b.end});
      }
    });
  }

  function populateStartTimes(occupancy){
    lastOccupancy = occupancy;
    const prevStart = startSelect.value;
    startSelect.innerHTML = '';
    const todayStr = isoToday();
    const selectedDay = daySelect.value;
    const now = nowTime();
    let allDisabled=true;

    const currentPlayer = (playerSelect.value==='other')?playerExternal.value.trim():playerSelect.value;
    const currentPlayerBookings = (playerBookings[selectedDay] && playerBookings[selectedDay][currentPlayer])||[];

    slots.slice(0, slots.length-1).forEach(t=>{
      const opt = new Option(t,t);
      if(selectedDay===todayStr && t<=now) { opt.disabled=true; opt.classList.add('disabled-slot'); }

      // Match-day block
      if(occupancy.match_day && occupancy.match_start && occupancy.match_end){
        const inRange = t>=occupancy.match_start && t<occupancy.match_end;
        if(inRange && occupancy.occupied>=occupancy.capacity) { opt.disabled=true; opt.classList.add('disabled-slot'); }
      }

      // 1-hour/day limit
      const totalMinutes = currentPlayerBookings.reduce((sum,b)=>{
        const s = parseInt(b.start.split(':')[0])*60 + parseInt(b.start.split(':')[1]);
        const e = parseInt(b.end.split(':')[0])*60 + parseInt(b.end.split(':')[1]);
        return sum + (e-s);
      },0);
      if(totalMinutes>=60) opt.disabled=true;

      if(!opt.disabled) allDisabled=false;
      startSelect.append(opt);
    });

    if(allDisabled){
      startSelect.innerHTML='<option disabled selected>No available start times</option>';
      endSelect.innerHTML='<option disabled selected>No available end times</option>';
      submitBtn.disabled=true;
      return;
    } else {
      clearBookingWarning();
    }

    const stillValid = Array.from(startSelect.options).some(o => o.value===prevStart && !o.disabled);
    if(stillValid) startSelect.value=prevStart;
    else startSelect.selectedIndex = Array.from(startSelect.options).findIndex(o=>!o.disabled);

    submitBtn.disabled=false;
    updateEnd();
  }

  function updateEnd(){
    endSelect.innerHTML='';
    if(startSelect.selectedIndex===-1) return;

    const chosenStart=startSelect.value;
    const todayStr=isoToday();
    const selectedDay=daySelect.value;
    const now=nowTime();
    let allDisabled=true;

    const currentPlayer = (playerSelect.value==='other')?playerExternal.value.trim():playerSelect.value;
    const currentPlayerBookings = (playerBookings[selectedDay] && playerBookings[selectedDay][currentPlayer])||[];
    const totalMinutesBooked = currentPlayerBookings.reduce((sum,b)=>{
      const s = parseInt(b.start.split(':')[0])*60 + parseInt(b.start.split(':')[1]);
      const e = parseInt(b.end.split(':')[0])*60 + parseInt(b.end.split(':')[1]);
      return sum + (e-s);
    },0);
    const maxDuration = Math.min(60-totalMinutesBooked,60);

    slots.forEach(t=>{
      if(t<=chosenStart) return;
      const opt = new Option(t,t);
      const startMinutes = parseInt(chosenStart.split(':')[0])*60 + parseInt(chosenStart.split(':')[1]);
      const endMinutes = parseInt(t.split(':')[0])*60 + parseInt(t.split(':')[1]);
      if(endMinutes-startMinutes>maxDuration) { opt.disabled=true; opt.classList.add('disabled-slot'); }
      if(selectedDay===todayStr && t<=now) { opt.disabled=true; opt.classList.add('disabled-slot'); }

      // Match-day block
      if(lastOccupancy && lastOccupancy.match_day && lastOccupancy.match_start && lastOccupancy.match_end){
        const inRange = t>lastOccupancy.match_start && t<=lastOccupancy.match_end;
        if(inRange && lastOccupancy.occupied>=lastOccupancy.capacity){ opt.disabled=true; opt.classList.add('disabled-slot'); }
      }

      if(!opt.disabled) allDisabled=false;
      endSelect.append(opt);
    });

    if(allDisabled){
      endSelect.innerHTML='<option disabled selected>No available end times</option>';
      submitBtn.disabled=true;
    } else {
      endSelect.selectedIndex = Array.from(endSelect.options).findIndex(o=>!o.disabled);
      submitBtn.disabled=false;
    }
  }

  function showBookingWarning(msg){
    let warning=document.getElementById('bookingWarning');
    if(!warning){
      const form=document.getElementById('bookingForm');
      warning=document.createElement('div');
      warning.id='bookingWarning';
      warning.className='text-danger fw-bold mb-2';
      form.prepend(warning);
    }
    warning.textContent=msg;
    warning.style.display='block';
  }

  function clearBookingWarning(){
    const warning=document.getElementById('bookingWarning');
    if(warning) warning.style.display='none';
  }

  function zurichDateString(dateStr){
    const date=new Date(dateStr+"T00:00:00Z");
    return date.toLocaleDateString('de-DE',{weekday:'long',year:'numeric',month:'2-digit',day:'2-digit',timeZone:'Europe/Zurich'});
  }

  async function loadBookings(){
    const res = await fetch('/bookings?t='+Date.now());
    const list = await res.json();
    updatePlayerBookings(list);

    const todayStr = new Date().toLocaleDateString('en-CA', {timeZone:'Europe/Zurich'});
    const tomorrowDate = new Date(); tomorrowDate.setDate(tomorrowDate.getDate()+1);
    const tomorrowStr = tomorrowDate.toLocaleDateString('en-CA', {timeZone:'Europe/Zurich'});

    const todayContainer = document.getElementById('bookings-today');
    const tomorrowContainer = document.getElementById('bookings-tomorrow');

    todayContainer.innerHTML = `<h5>Today — ${zurichDateString(todayStr)}</h5>`;
    tomorrowContainer.innerHTML = `<h5>Tomorrow — ${zurichDateString(tomorrowStr)}</h5>`;

    function groupByPeriod(list){
      const periods = { "Morning 06:00-12:00": [], "Afternoon 12:00-18:00": [], "Evening 18:00-00:00": [] };
      list.forEach(b=>{
        const h=parseInt(b.start.split(':')[0]);
        if(h>=6 && h<12) periods["Morning 06:00-12:00"].push(b);
        else if(h>=12 && h<18) periods["Afternoon 12:00-18:00"].push(b);
        else periods["Evening 18:00-00:00"].push(b);
      });
      return periods;
    }

function renderPeriod(periodBookings, label, container) {
    if (periodBookings.length === 0) return;
    const grpDiv = document.createElement('div');
    grpDiv.className = 'mb-3';
    const header = document.createElement('strong');
    header.textContent = label;
    grpDiv.appendChild(header);

    // Calculate total booked time per player
    const totalTimePerPlayer = {};
    periodBookings.forEach(b => {
        if (!totalTimePerPlayer[b.player]) totalTimePerPlayer[b.player] = 0;
        const s = parseInt(b.start.split(':')[0]) * 60 + parseInt(b.start.split(':')[1]);
        const e = parseInt(b.end.split(':')[0]) * 60 + parseInt(b.end.split(':')[1]);
        totalTimePerPlayer[b.player] += e - s;
    });

    periodBookings.forEach(b => {
        const card = document.createElement('div');
        card.className = 'card p-2 mb-1 shadow-sm';

        const bookedTime = b.created_at ? new Date(b.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Unknown';
        const checkinTime = b.checked_in_at ? ` | Checked in: ${new Date(b.checked_in_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : '';
        const timeText = `(${b.start}–${b.end} — Booked at: ${bookedTime}${checkinTime})`;
        const partnerText = b.partner ? b.partner : "(no partner)";

        // Highlight if player reached 1 hour
        const playerTotal = totalTimePerPlayer[b.player];
        const totalDisplay = `${Math.floor(playerTotal / 60)}h ${playerTotal % 60}m`;
        const totalClass = playerTotal >= 60 ? 'text-danger fw-bold' : 'text-muted';

        let buttons = '';
        const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Zurich' });
        const isFuture = b.day > todayStr;
        if (b.status === 'booked') buttons += `<button class="btn btn-success btn-sm me-2" ${isFuture ? 'disabled title="Cannot check in for future days"' : `onclick="checkin(${b.booking_id})"`}>Check-in</button>`;
        if (b.status === 'checked-in') buttons += `<button class="btn btn-warning btn-sm me-2" onclick="checkout(${b.booking_id})">Checkout</button>`;
        {% if is_admin %} buttons += `<button class="btn btn-danger btn-sm" onclick="deleteBooking(${b.booking_id})">Delete</button>`; {% endif %}

        card.innerHTML = `
            <div><b>${b.player}</b> <i>${timeText}</i> + ${partnerText}</div>
            <div>Total booked today: <span class="${totalClass}">${totalDisplay}</span></div>
            <div>Booked for: ${b.day}</div>
            <div>Status: <b>${b.status}</b></div>
            <div class="mt-1">${buttons}</div>
        `;
        grpDiv.appendChild(card);
    });

    container.appendChild(grpDiv);
}


    const todayBookings=list.filter(b=>b.day===todayStr).sort((a,b)=>a.start.localeCompare(b.start));
    const tomorrowBookings=list.filter(b=>b.day===tomorrowStr).sort((a,b)=>a.start.localeCompare(b.start));

    const groupedToday = groupByPeriod(todayBookings);
    Object.keys(groupedToday).forEach(label=>renderPeriod(groupedToday[label],label,todayContainer));

    const groupedTomorrow = groupByPeriod(tomorrowBookings);
    Object.keys(groupedTomorrow).forEach(label=>renderPeriod(groupedTomorrow[label],label,tomorrowContainer));

    if(todayBookings.length===0 && tomorrowBookings.length===0){
      todayContainer.innerHTML="<p class='text-center text-muted'>No bookings yet</p>";
    }
  }

  async function loadOccupancy(){
    const res=await fetch('/occupancy?t='+Date.now());
    const j=await res.json();
    occupancyValue.textContent=`${j.occupied} / ${j.capacity}`;
    occupancyValue.className="fs-3 fw-bold "+(j.occupied<6?"occupancy-green":j.occupied<11?"occupancy-yellow":"occupancy-red");

    if(j.match_start && j.match_end && j.match_day){
      matchDayNotice.style.display='block';
      matchInfo.style.display='block';
      matchInfo.textContent=`Match during the following slot : ${j.match_start} – ${j.match_end}`;
    } else {
      matchDayNotice.style.display='none';
      matchInfo.style.display='none';
    }

    populateStartTimes(j);
  }

  document.getElementById('bookingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const player=(playerSelect.value==='other')?playerExternal.value.trim():playerSelect.value;
    if(!player){alert('Please enter player name'); return;}
    let partner=(partnerSelect.value==='other')?partnerExternal.value.trim()||null:partnerSelect.value||null;
    let partnerToSend=partner||`None-${Date.now()}-${Math.floor(Math.random()*10000)}`;
    const fd=new FormData();
    fd.append('player',player); fd.append('partner',partnerToSend);
    fd.append('day',daySelect.value); fd.append('start',startSelect.value); fd.append('end',endSelect.value);
    const resp=await fetch('/book',{method:'POST',body:fd}); const j=await resp.json();
    if(j.ok){
      document.getElementById('bookingForm').reset();
      playerExternal.style.display='none'; partnerExternal.style.display='none';
      await loadBookings(); await loadOccupancy();
      new bootstrap.Modal(document.getElementById('userPopup')).show();
    } else alert(j.error||'Booking failed');
  });

  window.checkin=async id=>{ await fetch('/checkin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({booking_id:id})}); await loadBookings(); await loadOccupancy(); };
  window.checkout=async id=>{ await fetch('/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({booking_id:id})}); await loadBookings(); await loadOccupancy(); };
  window.deleteBooking=async id=>{ await fetch('/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({booking_id:id})}); await loadBookings(); await loadOccupancy(); };

  {% if is_admin %}
  document.getElementById('save_settings').addEventListener('click', async ()=>{
    const payload={
      match_day:document.getElementById('match_day').checked,
      match_start:document.getElementById('match_start').value||"",
      match_end:document.getElementById('match_end').value||"",
      extra_table:document.getElementById('extra_table').checked,
      second_match:document.getElementById('second_match').checked,
      second_match_extra_table:document.getElementById('second_match_extra_table').checked
    };
    await fetch('/update-settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    await loadOccupancy(); await loadBookings();
  });
  {% endif %}

  loadBookings(); loadOccupancy();
  setInterval(loadOccupancy,5000);
});
</script>

{% include 'footer.html' %}
</body>
</html>
